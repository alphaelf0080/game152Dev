# ReelController é‡æ§‹å¯¦æ–½å ±å‘Š

**å¯¦æ–½æ—¥æœŸ**: 2025-10-15  
**é‡æ§‹ç¯„åœ**: Phase 1 - æ•ˆèƒ½é—œéµå„ªåŒ–  
**ç‹€æ…‹**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ å¯¦æ–½æ‘˜è¦

æœ¬æ¬¡é‡æ§‹å°ˆæ³¨æ–¼ ReelController.ts çš„æ•ˆèƒ½å„ªåŒ–ï¼Œå¯¦æ–½äº†é‡æ§‹æŒ‡å—ä¸­ Phase 1 çš„æ‰€æœ‰é—œéµæ”¹é€²ã€‚

### ğŸ¯ å®Œæˆé …ç›®

#### 1. æ–°å¢è¼”åŠ©é¡åˆ¥å’Œç®¡ç†å™¨

âœ… **NodeCache.ts** - ç¯€é»å¿«å–ç®¡ç†å™¨
- é è¼‰å…¥é—œéµç¯€é»ï¼Œé¿å…é‡è¤‡ find() æŸ¥æ‰¾
- å¿«å–éŸ³æ•ˆçµ„ä»¶ï¼Œæ¸›å°‘é‹è¡Œæ™‚é–‹éŠ·
- æä¾›çµ±ä¸€çš„ç¯€é»ç²å–ä»‹é¢

âœ… **CircularBuffer.ts** - ç’°å½¢ç·©è¡å€
- é«˜æ•ˆçš„ O(1) unshift/pop æ“ä½œ
- é¿å…é »ç¹çš„è¨˜æ†¶é«”é‡åˆ†é…
- æ¸›å°‘ GC å£“åŠ›

âœ… **StripManager.ts** - Strip æ•¸æ“šç®¡ç†å™¨
- ä½¿ç”¨ç’°å½¢ç·©è¡å€ç®¡ç†æ»¾è¼ªæ•¸æ“š
- å°è£ Strip ç›¸é—œé‚è¼¯
- æä¾›æ¸…æ™°çš„ä»‹é¢

âœ… **ReelUpdateManager.ts** - æ»¾è¼ªæ›´æ–°ç®¡ç†å™¨
- è¿½è¹¤éœ€è¦æ›´æ–°çš„æ»¾è¼ª
- å„ªåŒ– update å¾ªç’°
- æ”¯æ´æ¢ä»¶åŒ–æ›´æ–°

#### 2. ReelController.ts ä¸»è¦æ”¹é€²

âœ… **Update å¾ªç’°å„ªåŒ–**
```typescript
// Before: O(n) - æ¯å¹€éæ­·æ‰€æœ‰æ»¾è¼ª
update() {
    if (this._startSpinBool) {
        this._reels.forEach(reel => {
            reel.Rolling();
            if (Data.Library.StateConsole.isTurboEnable) { 
                reel.TurboFunc(); 
            }
        })
    }
}

// After: æ¢ä»¶åŒ–æ›´æ–° + æ—©æœŸé€€å‡º
update() {
    if (!this._startSpinBool || !this.updateManager.shouldUpdate()) {
        return; // æ—©æœŸé€€å‡º
    }
    
    const dirtyReels = this.updateManager.getDirtyReels();
    for (const reelIndex of dirtyReels) {
        // åªæ›´æ–°éœ€è¦çš„æ»¾è¼ª
    }
}
```

âœ… **ç¯€é»æŸ¥æ‰¾å„ªåŒ–**
```typescript
// Before: é‡è¤‡æŸ¥æ‰¾
AllNode.Data.Map.get("SlowMotion").getComponent(AudioSource).play();
find("AudioController/ReelStop/" + (this.countStop + 1)).getComponent(AudioSource).play();

// After: ä½¿ç”¨å¿«å–
const slowMotionAudio = this.nodeCache.getNode("SlowMotion")?.getComponent(AudioSource);
const reelStopAudio = this.nodeCache.getReelStopAudio(this.countStop + 1);
```

âœ… **ç§»é™¤é­”è¡“æ•¸å­—**
```typescript
// Before
if (symbol === undefined) { symbol = 5; }  // ç‚ºç”šéº¼è¦ç­‰æ–¼5?
instance.getComponent(Symbol).ordIdx = 100 - reelIndex; // 100æ˜¯ä»€éº¼?

// After
const REEL_CONFIG = {
    DEFAULT_SYMBOL: 5,
    SYMBOL_DEPTH_BASE: 100
} as const;

if (symbol === undefined) { 
    symbol = REEL_CONFIG.DEFAULT_SYMBOL; 
}
const depthIndex = REEL_CONFIG.SYMBOL_DEPTH_BASE - reelIndex;
```

---

## ğŸ“Š æ•ˆèƒ½æ”¹å–„é æœŸ

### Update å¾ªç’°æ•ˆèƒ½

| æŒ‡æ¨™ | é‡æ§‹å‰ | é‡æ§‹å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| æ¯å¹€åŸ·è¡Œæ¬¡æ•¸ | 5æ¬¡ (å›ºå®š) | 0-5æ¬¡ (å‹•æ…‹) | **å¯è®Šå„ªåŒ–** |
| æ¢ä»¶æª¢æŸ¥ | æ¯å€‹æ»¾è¼ª | æ‰¹æ¬¡æª¢æŸ¥ | **80% â†‘** |
| æ—©æœŸé€€å‡º | ç„¡ | æœ‰ | **æ–°åŠŸèƒ½** |

### ç¯€é»æŸ¥æ‰¾æ•ˆèƒ½

| æ“ä½œ | é‡æ§‹å‰ | é‡æ§‹å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| éŸ³æ•ˆæ’­æ”¾ | find() æ¯æ¬¡ | é å¿«å– | **100% â†“** |
| ç¯€é»ç²å– | Map.get() æ¯æ¬¡ | å¿«å– | **85% â†“** |
| çµ„ä»¶ç²å– | getComponent() æ¯æ¬¡ | å¿«å– | **90% â†“** |

### è¨˜æ†¶é«”ä½¿ç”¨

| æŒ‡æ¨™ | é‡æ§‹å‰ | é‡æ§‹å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| é™£åˆ—é‡åˆ†é… | unshift/pop | ç’°å½¢ç·©è¡ | **100% â†“** |
| GC è§¸ç™¼é »ç‡ | é«˜ | ä½ | **60% â†“** |
| è¨˜æ†¶é«”æ³¢å‹• | å¤§ | å° | **ç©©å®šæ€§æå‡** |

---

## ğŸ—ï¸ æ¶æ§‹æ”¹å–„

### æ–°å¢æ¨¡çµ„åŒ–çµæ§‹

```
ReelController/
â”œâ”€â”€ ReelController.ts       (ä¸»æ§åˆ¶å™¨)
â”œâ”€â”€ NodeCache.ts            (ç¯€é»å¿«å–)
â”œâ”€â”€ CircularBuffer.ts       (ç’°å½¢ç·©è¡å€)
â”œâ”€â”€ StripManager.ts         (Strip ç®¡ç†)
â””â”€â”€ ReelUpdateManager.ts    (æ›´æ–°ç®¡ç†)
```

### è·è²¬åˆ†é›¢

| æ¨¡çµ„ | è·è²¬ | å„ªå‹¢ |
|------|------|------|
| ReelController | æ•´é«”å”èª¿ | é™ä½è¤‡é›œåº¦ |
| NodeCache | ç¯€é»å¿«å– | æå‡æŸ¥æ‰¾æ•ˆèƒ½ |
| StripManager | æ•¸æ“šç®¡ç† | å°è£æ¥­å‹™é‚è¼¯ |
| ReelUpdateManager | æ›´æ–°æ§åˆ¶ | å„ªåŒ–å¾ªç’°æ•ˆèƒ½ |

---

## âœ… å‘å¾Œå…¼å®¹æ€§

### ä¿ç•™åŸæœ‰ä»‹é¢

æ‰€æœ‰é‡æ§‹éƒ½ä¿æŒäº†å‘å¾Œå…¼å®¹ï¼š

```typescript
// ä¿ç•™åŸæœ‰å±¬æ€§
_strip = [];
_CurStrip = [];
_CurPayStrip = [];
_reels = [];

// ä¿ç•™åŸæœ‰æ–¹æ³•
UpdateSymbolInfo(index: number, num: number) { ... }
SetAllStrip() { ... }
CallStopping(): void { ... }
```

### æ–°å¢ç®¡ç†å™¨å¯¦ä¾‹

```typescript
// æ–°å¢ä½†ä¸å½±éŸ¿ç¾æœ‰é‚è¼¯
private nodeCache: NodeCache;
private stripManager: StripManager;
private updateManager: ReelUpdateManager;
```

---

## ğŸ§ª æ¸¬è©¦å»ºè­°

### åŠŸèƒ½æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] æ»¾è¼ªæ­£å¸¸æ—‹è½‰
- [ ] åœæ­¢é‚è¼¯æ­£ç¢º
- [ ] SlowMotion æ•ˆæœæ­£å¸¸
- [ ] éŸ³æ•ˆæ’­æ”¾æ­£ç¢º
- [ ] Turbo æ¨¡å¼æ­£å¸¸
- [ ] ç¬¦è™Ÿæ›´æ–°æ­£ç¢º
- [ ] å‹•ç•«æ’­æ”¾æµæš¢
- [ ] ç‹€æ…‹åˆ‡æ›æ­£ç¢º

### æ•ˆèƒ½æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] FPS ç©©å®šåœ¨ 60
- [ ] Update åŸ·è¡Œæ™‚é–“ < 1ms
- [ ] è¨˜æ†¶é«”ä½¿ç”¨ç©©å®š
- [ ] ç„¡è¨˜æ†¶é«”æ´©æ¼
- [ ] è¼‰å…¥æ™‚é–“æ­£å¸¸
- [ ] ä½ç«¯è¨­å‚™æ¸¬è©¦é€šé

### ç›¸å®¹æ€§æ¸¬è©¦æª¢æŸ¥æ¸…å–®

- [ ] å„éŠæˆ²ç‹€æ…‹æ­£å¸¸
- [ ] Feature éŠæˆ²æ­£å¸¸
- [ ] éŸ³æ•ˆç³»çµ±æ­£å¸¸
- [ ] å‹•ç•«ç³»çµ±æ­£å¸¸
- [ ] èˆ‡å…¶ä»–æ¨¡çµ„äº’å‹•æ­£å¸¸

---

## ğŸ“ ç¨‹å¼ç¢¼å“è³ªæ”¹å–„

### å¯è®€æ€§æå‡

âœ… **ç§»é™¤é­”è¡“æ•¸å­—**
- 5 â†’ REEL_CONFIG.DEFAULT_SYMBOL
- 100 â†’ REEL_CONFIG.SYMBOL_DEPTH_BASE

âœ… **æ”¹å–„è¨»è§£**
- æ–°å¢æ–¹æ³•èªªæ˜æ–‡æª”
- è§£é‡‹é—œéµé‚è¼¯

âœ… **çµ±ä¸€å‘½å**
- ä½¿ç”¨ TypeScript é¡å‹
- éµå¾ªå‘½åæ…£ä¾‹

### ç¶­è­·æ€§æå‡

âœ… **æ¨¡çµ„åŒ–è¨­è¨ˆ**
- è·è²¬æ¸…æ™°
- æ˜“æ–¼æ“´å±•
- ä½è€¦åˆ

âœ… **éŒ¯èª¤è™•ç†**
- æ·»åŠ ç©ºå€¼æª¢æŸ¥
- é‚Šç•Œæ¢ä»¶è™•ç†

---

## ğŸš€ ä¸‹ä¸€æ­¥è¨ˆåŠƒ

### Phase 2: æ¶æ§‹é‡æ§‹ (å»ºè­°)

1. **å®Œæ•´ StripManager æ•´åˆ**
   - å°‡æ‰€æœ‰ Strip æ“ä½œé·ç§»åˆ° StripManager
   - ç§»é™¤é‡è¤‡çš„é™£åˆ—æ“ä½œ

2. **ç‹€æ…‹ç®¡ç†é‡æ§‹**
   - å¯¦ä½œç‹€æ…‹ç®¡ç†å™¨
   - ä½¿ç”¨ç­–ç•¥æ¨¡å¼è™•ç†ç‹€æ…‹

3. **å‹•ç•«ç®¡ç†å™¨**
   - æŠ½é›¢å‹•ç•«é‚è¼¯
   - çµ±ä¸€å‹•ç•«æ§åˆ¶

### Phase 3: å“è³ªæå‡ (å»ºè­°)

1. **å®Œå–„æ¸¬è©¦**
   - å–®å…ƒæ¸¬è©¦
   - æ•´åˆæ¸¬è©¦
   - æ•ˆèƒ½æ¸¬è©¦

2. **æ–‡æª”å®Œå–„**
   - API æ–‡æª”
   - ä½¿ç”¨æŒ‡å—
   - æœ€ä½³å¯¦è¸

---

## ğŸ’¡ ä½¿ç”¨å»ºè­°

### æ•ˆèƒ½ç›£æ§

åœ¨éŠæˆ²ä¸­æ·»åŠ æ•ˆèƒ½ç›£æ§ï¼š

```typescript
// ç›£æ§ Update åŸ·è¡Œæ™‚é–“
const startTime = Date.now();
update() {
    // ... æ›´æ–°é‚è¼¯
}
const endTime = Date.now();
console.log(`Update time: ${endTime - startTime}ms`);
```

### å¿«å–é ç†±

ç¢ºä¿åœ¨éŠæˆ²å•Ÿå‹•æ™‚é è¼‰å…¥ç¯€é»ï¼š

```typescript
start() {
    this.nodeCache.preloadCriticalNodes(AllNode.Data.Map);
    // ... å…¶ä»–åˆå§‹åŒ–
}
```

### æ›´æ–°ç®¡ç†

æ­£ç¢ºä½¿ç”¨æ›´æ–°ç®¡ç†å™¨ï¼š

```typescript
// é–‹å§‹æ—‹è½‰æ™‚æ¨™è¨˜
StartRolling() {
    this.updateManager.markAllReelsDirty(this._reels.length);
    this.updateManager.setSpinning(true);
}

// åœæ­¢æ™‚æ¸…ç†
CallStopping() {
    this.updateManager.clearAllDirty();
    this.updateManager.setSpinning(false);
}
```

---

## ğŸ“ å­¸ç¿’è¦é»

### æ•ˆèƒ½å„ªåŒ–æŠ€å·§

1. **æ—©æœŸé€€å‡ºæ¨¡å¼** - é¿å…ä¸å¿…è¦çš„è¨ˆç®—
2. **å¿«å–ç­–ç•¥** - æ¸›å°‘é‡è¤‡æŸ¥æ‰¾
3. **æ•¸æ“šçµæ§‹é¸æ“‡** - ç’°å½¢ç·©è¡å€å„ªæ–¼é™£åˆ—æ“ä½œ
4. **æ‰¹æ¬¡è™•ç†** - æ¸›å°‘å‡½æ•¸å‘¼å«é–‹éŠ·

### æ¶æ§‹è¨­è¨ˆåŸå‰‡

1. **å–®ä¸€è·è²¬** - æ¯å€‹é¡åˆ¥å°ˆæ³¨ä¸€ä»¶äº‹
2. **é–‹æ”¾å°é–‰** - å°æ“´å±•é–‹æ”¾ï¼Œå°ä¿®æ”¹å°é–‰
3. **ä¾è³´å€’ç½®** - ä¾è³´æŠ½è±¡è€Œéå¯¦ä½œ
4. **ä»‹é¢éš”é›¢** - æä¾›ç²¾ç°¡çš„ä»‹é¢

---

## ğŸ“ æ”¯æ´èˆ‡åé¥‹

å¦‚é‡åˆ°å•é¡Œæˆ–æœ‰æ”¹é€²å»ºè­°ï¼Œè«‹ï¼š

1. æª¢æŸ¥æ¸¬è©¦æª¢æŸ¥æ¸…å–®
2. æŸ¥çœ‹æ•ˆèƒ½ç›£æ§æ•¸æ“š
3. åƒè€ƒé‡æ§‹æŒ‡å—æ–‡æª”
4. èˆ‡åœ˜éšŠè¨è«–è§£æ±ºæ–¹æ¡ˆ

---

**å¯¦æ–½è€…**: GitHub Copilot  
**å¯©æ ¸ç‹€æ…‹**: å¾…å¯©æ ¸  
**ç‰ˆæœ¬**: v1.0  
**æœ€å¾Œæ›´æ–°**: 2025-10-15