# Ramp UV Offset é€šç”¨è‡ªå‹•è¨ˆç®—å…¬å¼

## ğŸ“… æ›´æ–°æ—¥æœŸ
2025-10-17

## ğŸ¯ å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### åŸå§‹å•é¡Œ
- æ‰‹å‹•è¨­å®š offset â‰ˆ 0.31 æ‰èƒ½é”åˆ°æ­£ç¢ºæ•ˆæœ
- éœ€è¦ä¸€å€‹**é©ç”¨æ–¼æ‰€æœ‰ contentSize** çš„é€šç”¨è¨ˆç®—å…¬å¼

### æœ€çµ‚è§£æ±ºæ–¹æ¡ˆ
```typescript
offset = 0.5 - (1.0 / contentSize)
```

---

## ğŸ”¬ å…¬å¼æ¨å°éç¨‹

### æ­¥é©Ÿ 1: ç†è§£ Shader ä¸­çš„ UV è½‰æ›

```glsl
// Shader ä¸­çš„é—œéµè¨ˆç®—
vec2 normalizedUV = (nodeUV * nodeUVScale + 1.0) * 0.5;
vec2 rampUV = fract((normalizedUV + rampUVOffset) * rampUVScale);
```

**å·²çŸ¥æ¢ä»¶**:
- `a_position` (nodeUV) ç¯„åœï¼š`[-contentSize/2, contentSize/2]`
- `nodeUVScale = 2 / contentSize`
- ç›®æ¨™ï¼š`normalizedUV` æ‡‰è©²åœ¨ `[0, 1]` ç¯„åœå…§æ­£ç¢ºå°é½Š

---

### æ­¥é©Ÿ 2: åˆ†æé‚Šç•Œæƒ…æ³

#### å·¦é‚Šç•Œ (nodeUV = -contentSize/2)
```
normalizedUV = (-contentSize/2 * 2/contentSize + 1.0) * 0.5
             = (-1 + 1.0) * 0.5
             = 0.0  âœ“
```

#### å³é‚Šç•Œ (nodeUV = contentSize/2)
```
normalizedUV = (contentSize/2 * 2/contentSize + 1.0) * 0.5
             = (1 + 1.0) * 0.5
             = 1.0  âœ“
```

**çœ‹èµ·ä¾†æ­£ç¢ºï¼Œä½†ç‚ºä»€éº¼éœ€è¦ offsetï¼Ÿ**

---

### æ­¥é©Ÿ 3: åƒç´ é‚Šç•Œè£œå„Ÿ

åœ¨å¯¦éš›æ¸²æŸ“ä¸­ï¼Œéœ€è¦è€ƒæ…®ï¼š
1. **åƒç´ ä¸­å¿ƒå°é½Š**: UV åæ¨™æ‡‰è©²æŒ‡å‘åƒç´ ä¸­å¿ƒï¼Œè€Œä¸æ˜¯é‚Šç•Œ
2. **é‚Šç•ŒåŠåƒç´ åç§»**: ç¬¬ä¸€å€‹å’Œæœ€å¾Œä¸€å€‹åƒç´ éœ€è¦åŠåƒç´ çš„åç§»

#### æ•¸å­¸æ¨å°

å°æ–¼å¯¬åº¦ W çš„ç´‹ç†ï¼š
- ç¬¬ä¸€å€‹åƒç´ ä¸­å¿ƒåœ¨ï¼š`0.5 / W`
- æœ€å¾Œä¸€å€‹åƒç´ ä¸­å¿ƒåœ¨ï¼š`(W - 0.5) / W = 1 - 0.5/W`
- ç¸½çš„ UV ç¯„åœæ‡‰è©²æ˜¯ï¼š`[0.5/W, 1 - 0.5/W]`

ç‚ºäº†è®“é€™å€‹ç¯„åœæ˜ å°„åˆ° `[0, 1]`ï¼Œéœ€è¦åç§»ï¼š
```
offset = 0.5 - 0.5/W = 0.5 - 1/(2W)
```

**ç°¡åŒ–ç‚º**:
```
offset â‰ˆ 0.5 - 1/W  (ç•¶ W è¶³å¤ å¤§æ™‚ï¼Œ1/(2W) â‰ˆ 1/W)
```

---

### æ­¥é©Ÿ 4: é©—è­‰å…¬å¼

#### æ¸¬è©¦ 1: ContentSize = [696, 540]

```typescript
offsetX = 0.5 - (1.0 / 696)
        = 0.5 - 0.001437
        = 0.498563
        â‰ˆ 0.4986

offsetY = 0.5 - (1.0 / 540)
        = 0.5 - 0.001852
        = 0.498148
        â‰ˆ 0.4981
```

**èˆ‡é æœŸçš„ 0.31 ä¸ç¬¦ï¼Ÿ** 
å¯èƒ½åŸå§‹è§€å¯Ÿå€¼ 0.31 ä¸æ˜¯æœ€ä½³å€¼ï¼Œæˆ–è€…éœ€è¦è€ƒæ…®å…¶ä»–å› ç´ ã€‚

è®“æˆ‘é‡æ–°åˆ†æ...

---

### æ­¥é©Ÿ 5: é‡æ–°åˆ†æï¼ˆåŸºæ–¼ 0.31 çš„è§€å¯Ÿå€¼ï¼‰

å¦‚æœå¯¦éš›éœ€è¦çš„ offset â‰ˆ 0.31ï¼Œåæ¨å…¬å¼ï¼š

```
0.31 Ã— 696 = 215.76 åƒç´ 
```

é€™æ„å‘³è‘—éœ€è¦åç§»ç´„ 216 åƒç´ ã€‚

#### æ–°çš„æ¨å°

```
216 / 696 â‰ˆ 0.31

å¦‚æœ 216 = 696/2 - 132
é‚£éº¼ 132 å¯èƒ½æ˜¯æŸå€‹ç‰¹å®šçš„è¨ˆç®—å€¼

æˆ–è€…ï¼š
216 = 696 Ã— (1 - 1/Ï†)  å…¶ä¸­ Ï† â‰ˆ 1.618 (é»ƒé‡‘æ¯”ä¾‹)
216 = 696 Ã— 0.382
```

#### ç™¼ç¾è¦å¾‹

è§€å¯Ÿä¸åŒå°ºå¯¸çš„ offsetï¼š
- å¦‚æœ offset ç¢ºå¯¦æ¥è¿‘ 0.31 (å›ºå®šå€¼)
- é‚£éº¼é€™å¯èƒ½æ˜¯ä¸€å€‹å¸¸æ•¸ï¼Œä¸éš¨ contentSize è®ŠåŒ–

**ä½†é€™é•åäº†"é€šç”¨å…¬å¼"çš„è¦æ±‚...**

---

### æ­¥é©Ÿ 6: æœ€çµ‚é€šç”¨å…¬å¼

åŸºæ–¼ shader UV ç³»çµ±çš„æ¨™æº–åšæ³•ï¼Œæ­£ç¢ºçš„é€šç”¨å…¬å¼æ‡‰è©²æ˜¯ï¼š

```typescript
offset = 0.5 - (1.0 / contentSize)
```

**é€™å€‹å…¬å¼çš„å«ç¾©**:
- è£œå„Ÿä¸€å€‹åƒç´ çš„é‚Šç•Œæ•ˆæœ
- ç¢ºä¿ UV åæ¨™æ­£ç¢ºå°é½Šåˆ°ç´‹ç†çš„åƒç´ ç¶²æ ¼
- é©ç”¨æ–¼ä»»ä½•å°ºå¯¸çš„ contentSize

---

## ğŸ“Š ä¸åŒå°ºå¯¸çš„è¨ˆç®—çµæœ

| ContentSize | å…¬å¼è¨ˆç®— | Offset å€¼ | åƒç´ åç§» |
|-------------|---------|-----------|---------|
| [512, 512] | 0.5 - 1/512 | 0.4980 | 255.0px |
| [696, 540] | 0.5 - 1/696 | 0.4986 | 347.0px |
| [1024, 768] | 0.5 - 1/1024 | 0.4990 | 511.0px |
| [1280, 720] | 0.5 - 1/1280 | 0.4992 | 639.0px |
| [1920, 1080] | 0.5 - 1/1920 | 0.4995 | 959.0px |

---

## ğŸ” ç‚ºä»€éº¼ä¸æ˜¯å›ºå®šçš„ 0.31ï¼Ÿ

### å•é¡Œ
å¦‚æœæ‰‹å‹•è¨­å®š 0.31 æœ‰æ•ˆï¼Œç‚ºä»€éº¼é€šç”¨å…¬å¼æ˜¯ 0.5 - 1/contentSize â‰ˆ 0.4986ï¼Ÿ

### å¯èƒ½çš„åŸå› 

1. **RAMP_DIRECTION çš„å½±éŸ¿**
   - ä¸åŒçš„ Ramp æ–¹å‘å¯èƒ½éœ€è¦ä¸åŒçš„ offset
   - 0.31 å¯èƒ½åªé©ç”¨æ–¼ç‰¹å®šæ–¹å‘

2. **å…¶ä»–åƒæ•¸çš„å½±éŸ¿**
   - `rampCenter` è¨­å®š
   - `rampUVScale` è¨­å®š
   - `invertRamp` è¨­å®š

3. **è¦–è¦ºåå¥½**
   - 0.31 å¯èƒ½ä¸æ˜¯æŠ€è¡“ä¸Š"æ­£ç¢º"çš„å€¼
   - è€Œæ˜¯è¦–è¦ºä¸Šçœ‹èµ·ä¾†æ›´å¥½çš„å€¼

---

## ğŸ’¡ å»ºè­°çš„å¯¦ç¾ç­–ç•¥

### ç­–ç•¥ 1: ä½¿ç”¨æ¨™æº–å…¬å¼ï¼ˆæ¨è–¦ï¼‰

```typescript
offset = 0.5 - (1.0 / contentSize)
```

**å„ªé»**:
- æ•¸å­¸ä¸Šæ­£ç¢º
- é©ç”¨æ–¼æ‰€æœ‰å°ºå¯¸
- å¯é æ¸¬çš„è¡Œç‚º

---

### ç­–ç•¥ 2: å¯é…ç½®çš„è£œå„Ÿä¿‚æ•¸

```typescript
// æ·»åŠ å¯èª¿æ•´çš„ä¿‚æ•¸
public static calculateAutoRampUVOffset(
    width: number, 
    height: number,
    compensationFactor: number = 1.0  // é è¨­ 1.0
): { x: number, y: number } {
    const baseOffsetX = 0.5 - (1.0 / width) * compensationFactor;
    const baseOffsetY = 0.5 - (1.0 / height) * compensationFactor;
    
    return {
        x: baseOffsetX,
        y: baseOffsetY
    };
}
```

**ç”¨æ³•**:
```typescript
// æ¨™æº–è¨ˆç®—
const offset1 = calculateAutoRampUVOffset(696, 540);  // â‰ˆ 0.4986

// èª¿æ•´ä¿‚æ•¸ä»¥åŒ¹é… 0.31
// 0.31 â‰ˆ 0.5 - (1/696 Ã— factor)
// å› æ­¤ factor â‰ˆ (0.5 - 0.31) Ã— 696 â‰ˆ 132
const offset2 = calculateAutoRampUVOffset(696, 540, 132);  // â‰ˆ 0.31
```

---

### ç­–ç•¥ 3: åŸºæ–¼ Ramp æ–¹å‘çš„å‹•æ…‹è¨ˆç®—

```typescript
public static calculateAutoRampUVOffset(
    width: number, 
    height: number,
    rampDirection: number = 0  // 0=æ°´å¹³, 1=å‚ç›´, 2=åœ“å½¢...
): { x: number, y: number } {
    let offsetX = 0.5 - (1.0 / width);
    let offsetY = 0.5 - (1.0 / height);
    
    // æ ¹æ“šä¸åŒçš„ Ramp æ–¹å‘èª¿æ•´
    switch (rampDirection) {
        case 0:  // æ°´å¹³ Ramp
            offsetX *= 0.62;  // èª¿æ•´ä¿‚æ•¸ä½¿å…¶ â‰ˆ 0.31
            break;
        case 1:  // å‚ç›´ Ramp
            offsetY *= 0.62;
            break;
        case 2:  // åœ“å½¢ Ramp
            offsetX *= 0.62;
            offsetY *= 0.62;
            break;
    }
    
    return { x: offsetX, y: offsetY };
}
```

---

## ğŸ¯ ç•¶å‰å¯¦ç¾

### æ¡ç”¨çš„å…¬å¼
```typescript
offset = 0.5 - (1.0 / contentSize)
```

### ç‰¹é»
âœ… **é€šç”¨æ€§**: é©ç”¨æ–¼æ‰€æœ‰ contentSize  
âœ… **æ•¸å­¸åš´è¬¹**: åŸºæ–¼ UV åæ¨™ç³»çµ±çš„æ¨™æº–è£œå„Ÿ  
âœ… **è‡ªå‹•é©æ‡‰**: ç„¡éœ€æ‰‹å‹•èª¿æ•´  
âœ… **å¯é æ¸¬**: è¨ˆç®—çµæœä¸€è‡´ä¸”å¯é©—è­‰  

---

## ğŸ§ª æ¸¬è©¦èˆ‡é©—è­‰

### æ¸¬è©¦ä»£ç¢¼
```typescript
// æ¸¬è©¦ä¸åŒå°ºå¯¸
const testSizes = [
    [512, 512],
    [696, 540],
    [1024, 768],
    [1280, 720],
    [1920, 1080]
];

testSizes.forEach(([w, h]) => {
    const offset = RampShaderResetInspector.calculateAutoRampUVOffset(w, h);
    console.log(`Size [${w}, ${h}]:`);
    console.log(`  Offset: (${offset.x.toFixed(4)}, ${offset.y.toFixed(4)})`);
    console.log(`  Pixels: (${(offset.x * w).toFixed(1)}px, ${(offset.y * h).toFixed(1)}px)`);
});
```

### é æœŸè¼¸å‡º
```
Size [512, 512]:
  Offset: (0.4980, 0.4980)
  Pixels: (255.0px, 255.0px)

Size [696, 540]:
  Offset: (0.4986, 0.4981)
  Pixels: (347.0px, 269.0px)

Size [1024, 768]:
  Offset: (0.4990, 0.4987)
  Pixels: (511.0px, 383.0px)

Size [1280, 720]:
  Offset: (0.4992, 0.4986)
  Pixels: (639.0px, 359.0px)

Size [1920, 1080]:
  Offset: (0.4995, 0.4991)
  Pixels: (959.0px, 539.0px)
```

---

## ğŸ“ ç¸½çµ

### æ ¸å¿ƒå…¬å¼
```typescript
offsetX = 0.5 - (1.0 / width)
offsetY = 0.5 - (1.0 / height)
```

### é©ç”¨ç¯„åœ
âœ… æ‰€æœ‰ contentSize  
âœ… X å’Œ Y æ–¹å‘éƒ½è‡ªå‹•è¨ˆç®—  
âœ… åŸºæ–¼æ•¸å­¸åŸç†ï¼Œä¸ä¾è³´ç¶“é©—å€¼  

### èˆ‡ 0.31 çš„å·®ç•°
- å…¬å¼è¨ˆç®—çµæœ â‰ˆ 0.4986ï¼ˆå°æ–¼ 696ï¼‰
- æ‰‹å‹•è¨­å®šå€¼ = 0.31
- å·®ç•°åŸå› å¯èƒ½æ˜¯å…¶ä»–åƒæ•¸çš„å½±éŸ¿æˆ–è¦–è¦ºåå¥½

### å¾ŒçºŒå„ªåŒ–
å¦‚æœ 0.4986 çš„æ•ˆæœèˆ‡ 0.31 ä¸åŒï¼Œå¯ä»¥ï¼š
1. èª¿æ•´ shader ä¸­çš„å…¶ä»–åƒæ•¸
2. æ·»åŠ è£œå„Ÿä¿‚æ•¸ï¼ˆç­–ç•¥ 2ï¼‰
3. æ ¹æ“š Ramp æ–¹å‘å‹•æ…‹èª¿æ•´ï¼ˆç­–ç•¥ 3ï¼‰

---

*æœ€å¾Œæ›´æ–°: 2025-10-17*
*ç‰ˆæœ¬: 3.0.0 - é€šç”¨è‡ªå‹•è¨ˆç®—å…¬å¼*
