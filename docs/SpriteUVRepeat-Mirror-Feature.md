# SpriteUVRepeat Shader - 鏡像翻轉功能說明

## 更新日期
2025年10月21日

## 新增功能

### 底層（Base Layer）鏡像翻轉功能
為主紋理（mainTexture）添加了以中心線為軸的鏡像翻轉控制：

- **Base Mirror Horizontal（底層水平鏡像）**
  - 參數名：`baseMirrorH`
  - 值範圍：0-1
  - 0 = 關閉鏡像
  - 1 = 開啟水平鏡像（以**垂直中心線**為軸，將左半部複製並翻轉到右半部）
  - 效果：左半部的圖像會鏡像顯示到右半部

- **Base Mirror Vertical（底層垂直鏡像）**
  - 參數名：`baseMirrorV`
  - 值範圍：0-1
  - 0 = 關閉鏡像
  - 1 = 開啟垂直鏡像（以**水平中心線**為軸，將上半部複製並翻轉到下半部）
  - 效果：上半部的圖像會鏡像顯示到下半部

### 第二層（Layer）鏡像翻轉功能
為第二層紋理（layerTexture）添加了獨立的鏡像翻轉控制：

- **Layer Mirror Horizontal（第二層水平鏡像）**
  - 參數名：`layerMirrorH`
  - 值範圍：0-1
  - 0 = 關閉鏡像
  - 1 = 開啟水平鏡像（以**垂直中心線**為軸，將左半部複製並翻轉到右半部）

- **Layer Mirror Vertical（第二層垂直鏡像）**
  - 參數名：`layerMirrorV`
  - 值範圍：0-1
  - 0 = 關閉鏡像
  - 1 = 開啟垂直鏡像（以**水平中心線**為軸，將上半部複製並翻轉到下半部）

## 鏡像原理說明

### 水平鏡像（Horizontal Mirror）
- 以**垂直中心線**（x = 0.5）為對稱軸
- 將紋理的**左半部**（x: 0.0 → 0.5）拉伸到整個寬度（x: 0.0 → 1.0）
- 右半部顯示左半部的鏡像翻轉

```
原始:     |左半部|右半部|
啟用後:   |左半部|左半部(翻轉)|
```

### 垂直鏡像（Vertical Mirror）
- 以**水平中心線**（y = 0.5）為對稱軸
- 將紋理的**上半部**（y: 0.0 → 0.5）拉伸到整個高度（y: 0.0 → 1.0）
- 下半部顯示上半部的鏡像翻轉

```
原始:     上半部
          ------
          下半部

啟用後:   上半部
          ------
          上半部(翻轉)
```

## 技術實現

### UV 鏡像函數
```glsl
vec2 applyMirror(vec2 uv, float mirrorH, float mirrorV) {
  vec2 result = uv;
  
  // 水平鏡像（以垂直中心線 x=0.5 為軸）
  if (mirrorH > 0.5) {
    // 如果在右半部 (x > 0.5)，則映射到左半部並翻轉
    if (result.x > 0.5) {
      result.x = 1.0 - result.x;
    }
    // 將 [0, 0.5] 映射到 [0, 1]，使左半部填滿整個寬度
    result.x = result.x * 2.0;
  }
  
  // 垂直鏡像（以水平中心線 y=0.5 為軸）
  if (mirrorV > 0.5) {
    // 如果在下半部 (y > 0.5)，則映射到上半部並翻轉
    if (result.y > 0.5) {
      result.y = 1.0 - result.y;
    }
    // 將 [0, 0.5] 映射到 [0, 1]，使上半部填滿整個高度
    result.y = result.y * 2.0;
  }
  
  return result;
}
```

### 應用流程

1. **底層紋理**：
   - 計算 UV 坐標（考慮 tiling 和 offset）
   - 應用 fract 來實現重複
   - 應用鏡射變換
   - 採樣紋理

2. **第二層紋理**：
   - 使用獨立的 UV 坐標系統
   - 計算 UV 坐標（使用 layerTilingOffset）
   - 應用 fract 來實現重複
   - 應用獨立的鏡射變換
   - 採樣紋理

## 使用範例

### 範例 1：底層水平鏡像（左右對稱）
```typescript
// 在 Cocos Creator 中設定
// 創建左右對稱效果
material.setProperty('baseMirrorH', 1.0); // 開啟水平鏡像
material.setProperty('baseMirrorV', 0.0); // 關閉垂直鏡像
// 結果：左半部的圖像會鏡像複製到右半部
```

### 範例 2：底層垂直鏡像（上下對稱）
```typescript
// 創建上下對稱效果
material.setProperty('baseMirrorH', 0.0); // 關閉水平鏡像
material.setProperty('baseMirrorV', 1.0); // 開啟垂直鏡像
// 結果：上半部的圖像會鏡像複製到下半部
```

### 範例 3：第二層四象限鏡像
```typescript
// 同時開啟第二層的水平和垂直鏡像
// 創建四象限對稱效果
material.setProperty('layerMirrorH', 1.0); // 開啟水平鏡像
material.setProperty('layerMirrorV', 1.0); // 開啟垂直鏡像
// 結果：左上角的圖像會鏡像複製到所有四個象限
```

### 範例 4：創建萬花筒效果
```typescript
// 底層正常，第二層四象限鏡像，創建萬花筒效果
material.setProperty('baseMirrorH', 0.0);
material.setProperty('baseMirrorV', 0.0);
material.setProperty('layerMirrorH', 1.0);
material.setProperty('layerMirrorV', 1.0);
material.setProperty('layerOpacity', 70.0); // 調整透明度混合
material.setProperty('layerBlendMode', 3.0); // 使用 Overlay 混合模式
```

### 範例 5：動態鏡像切換
```typescript
// 動態切換鏡像效果
let isMirrored = false;

function toggleMirror() {
  isMirrored = !isMirrored;
  material.setProperty('baseMirrorH', isMirrored ? 1.0 : 0.0);
}

// 在更新循環中調用
this.schedule(toggleMirror, 2.0); // 每2秒切換一次
```

## 特點優勢

1. **真正的鏡像效果**：以中心線為軸，創建對稱的鏡像圖案
2. **獨立控制**：底層和第二層的鏡像完全獨立，互不影響
3. **靈活性**：可以單獨控制水平或垂直鏡像，或同時開啟創建四象限對稱
4. **效能優化**：使用簡單的數學運算，對效能影響極小
5. **易於使用**：布林型參數（0或1），直觀易懂
6. **無資源浪費**：只需要原圖的一半內容即可創建完整對稱效果

## 應用場景

1. **對稱圖案設計**：快速創建左右或上下對稱的圖案
2. **萬花筒效果**：同時開啟水平和垂直鏡像，創建四象限對稱
3. **裝飾花紋**：使用鏡像創建對稱的裝飾邊框或背景
4. **UI元素**：創建對稱的按鈕、框架等UI組件
5. **資源優化**：只需設計一半的圖案，通過鏡像生成完整效果，節省50%的紋理空間
6. **動態特效**：通過腳本控制鏡像開關，創建動態變化的視覺效果
7. **遊戲場景**：創建對稱的背景、地面等場景元素

## 視覺效果說明

### 單獨使用水平鏡像
```
原始紋理:           鏡像後:
┌────┬────┐        ┌────┬────┐
│ A  │ B  │        │ A  │ A' │
├────┼────┤   →    ├────┼────┤
│ C  │ D  │        │ C  │ C' │
└────┴────┘        └────┴────┘
```
說明：左半部（A、C）被拉伸並鏡像翻轉到右半部

### 單獨使用垂直鏡像
```
原始紋理:           鏡像後:
┌────┬────┐        ┌────┬────┐
│ A  │ B  │        │ A  │ B  │
├────┼────┤   →    ├────┼────┤
│ C  │ D  │        │ A' │ B' │
└────┴────┘        └────┴────┘
```
說明：上半部（A、B）被拉伸並鏡像翻轉到下半部

### 同時使用水平和垂直鏡像
```
原始紋理:           鏡像後:
┌────┬────┐        ┌────┬────┐
│ A  │ B  │        │ A  │ A' │
├────┼────┤   →    ├────┼────┤
│ C  │ D  │        │ A''│ A'''│
└────┴────┘        └────┴────┘
```
說明：只有左上角（A）被使用，鏡像到所有四個象限

## 注意事項

1. **鏡像順序**：鏡像在 UV tiling 和 offset 之後應用
2. **參數值**：雖然是浮點數，但建議只使用 0.0 或 1.0
3. **內容設計**：使用鏡像時，只需設計原圖的一半（或四分之一）
4. **無縫對接**：確保被鏡像的邊緣能與鏡像後的圖像無縫對接
5. **兩層獨立**：兩層的鏡像完全獨立，可以創建複雜的組合效果
6. **與其他效果配合**：鏡像不影響其他效果（HSV調整、混合模式等），可以組合使用

## 相容性

- Cocos Creator 3.8+
- 支援所有現有的 SpriteUVRepeat 功能
- 向下相容：不設定鏡像參數時，默認為關閉狀態（0.0）

## 效能考量

- 鏡像計算只涉及簡單的條件判斷和數學運算
- 不增加紋理採樣次數
- 對幀率影響可忽略不計
- 適合用於移動平台和低端設備

## 開發建議

1. **紋理設計**：設計紋理時可以只做一半（或四分之一），通過鏡像生成完整效果
2. **測試預覽**：在編輯器中即時調整鏡像參數，預覽效果
3. **組合使用**：結合 tiling、offset、混合模式等功能創造更豐富的效果
4. **動畫控制**：通過補間動畫平滑切換鏡像狀態（雖然是布林值，但可以創造特殊效果）
